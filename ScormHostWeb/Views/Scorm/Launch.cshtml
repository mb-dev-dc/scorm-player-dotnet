@model ScormHostWeb.Models.LaunchViewModel
@{
    Layout = null;
    var courseId = Model.CourseId;
    var userId = Model.UserId;
    var attemptId = Model.AttemptId;
    var resumeData = Model.ResumeData != null ? Newtonsoft.Json.JsonConvert.SerializeObject(Model.ResumeData) : "null";
    
    // Use the LaunchUrl from the service if available, otherwise construct a fallback
    var cleanUrl = Model.LaunchUrl;

    // Validate that the service-generated URL contains required parameters
    bool hasValidUrl = !string.IsNullOrEmpty(cleanUrl);
    bool hasAttemptId = hasValidUrl && cleanUrl.Contains("attemptId=");

    // Only construct manually if the service didn't provide a valid URL
    if (!hasValidUrl || !hasAttemptId)
    {
        // Log the issue for debugging
        Console.WriteLine($"Warning: Using fallback URL construction. LaunchUrl: {cleanUrl}, HasAttemptId: {hasAttemptId}");

        // Construct fallback URL with all required parameters
        var baseUrl = !string.IsNullOrEmpty(cleanUrl) ? cleanUrl.Split('?')[0] : $"~/scorm-packages/{courseId}/SHP/index_lms.html";

        if (!string.IsNullOrEmpty(attemptId?.ToString()))
        {
            cleanUrl = $"{baseUrl}?attemptId={attemptId}&courseId={courseId}&userId={userId}";
        }
        else
        {
            // This should rarely happen - log it as an error
            Console.WriteLine($"Error: No attemptId available for URL construction. CourseId: {courseId}, UserId: {userId}");
            cleanUrl = $"{baseUrl}?courseId={courseId}&userId={userId}";
        }
    }

    // Log the final URL for debugging
    Console.WriteLine($"Final iframe URL: {cleanUrl}");
}
<!DOCTYPE html>
<html>
<head>
    <title>SCORM Player - Development Mode</title>

    <!-- Meta tags for emergency parameter extraction -->
    <meta name="scorm-attempt-id" content="@Model.AttemptId" />
    <meta name="scorm-course-id" content="@Model.CourseId" />
    <meta name="scorm-user-id" content="@Model.UserId" />

    <!-- Expose resume data globally for the adapter BEFORE loading the adapter script -->
    <script>
        window.scormResumeData = @Html.Raw(resumeData);

        // Global variables for emergency parameter extraction
        window.scormAttemptId = '@Model.AttemptId';
        window.scormCourseId = '@Model.CourseId';
        window.scormUserId = '@Model.UserId';

        // Debug information
        window.scormDebugInfo = {
            attemptId: '@Model.AttemptId',
            courseId: '@Model.CourseId',
            userId: '@Model.UserId',
            isResume: @(Model.IsResume.ToString().ToLower()),
            originalLaunchUrl: '@Model.LaunchUrl',
            finalUrl: '@cleanUrl',
            hasAttemptIdInUrl: '@cleanUrl'.includes('attemptId='),
            timestamp: new Date().toISOString()
        };

        console.log('üîç SCORM Debug Info loaded:', window.scormDebugInfo);
    </script>

    <!-- Load SCORM API Adapter -->
    <script src="~/js/scripts/scorm-api-adapter.js"></script>
    <link href="~/css/player.css" rel="stylesheet" />
    
</head>
<body>
    <div class="dev-mode-header">
        <div class="header-info">
            <span>SCORM Player - Development Mode</span>
            @if (Model.IsResume)
            {
                <div class="resume-indicator">
                    <span class="resume-badge">RESUMING</span>
                    <div style="display: flex; flex-direction: column; gap: 2px;">
                        <span class="resume-details">
                            Attempt @Model.AttemptNumber |
                            Status: @Model.CompletionStatus |
                            @if (Model.ScoreRaw != null) { <text>Score: @Model.ScoreRaw | </text> }
                            Last accessed: @(Model.LastAccessedOn != null ? Model.LastAccessedOn.Value.ToString("MM/dd/yyyy HH:mm") : "Unknown")
                        </span>
                        @{
                            var resumeData = Model.ResumeData as dynamic;
                            var progressPercent = resumeData?.ProgressPercentage ?? 0;
                        }
                        <div style="display: flex; align-items: center;">
                            <div class="progress-container">
                                <div class="progress-bar" id="main-progress-bar" style="width: @(progressPercent)%"></div>
                            </div>
                            <span class="progress-text" id="main-progress-text">@(progressPercent)% complete</span>
                        </div>
                    </div>
                </div>
            }
            else
            {
                <div class="start-indicator">
                    <span class="start-badge">NEW ATTEMPT</span>
                    <span class="start-details">Starting fresh attempt</span>
                    <div style="display: flex; align-items: center; margin-top: 4px;">
                        <div class="progress-container">
                            <div class="progress-bar" id="main-progress-bar" style="width: 0%"></div>
                        </div>
                        <span class="progress-text" id="main-progress-text">0% complete</span>
                    </div>
                </div>
            }
        </div>
        <div class="header-controls">
            <button id="toggle-console">Show Console</button>
            <button id="toggle-fullscreen">Fullscreen</button>
            @if (Model.IsResume)
            {
                <button id="restart-course" class="restart-btn">Restart Course</button>
            }
        </div>
    </div>

    <!-- Debug panel toggle and panel -->
    <button id="debug-toggle" class="debug-toggle">Debug</button>
    <div id="debug-panel">
        <div style="font-weight: bold; margin-bottom: 5px;">üîç SCORM Debug Panel</div>
        <div id="debug-content"></div>
    </div>

    <div id="iframe-container" class="iframe-container">
        <iframe id="scorm-content" src="@cleanUrl" allowfullscreen></iframe>
    </div>

    <div id="dev-console">
        <div class="dev-console-header">
            <span>SCORM API Console</span>
            <button id="clear-console">Clear</button>
        </div>
        <div id="dev-console-content"></div>
    </div>
    
    <script>
        // Initialize SCORM adapter and dev tools
        document.addEventListener('DOMContentLoaded', function() {
            console.log('SCORM Player initialized for course: @courseId, user: @userId');
            
            // Development tools setup
            const toggleConsoleBtn = document.getElementById('toggle-console');
            const toggleFullscreenBtn = document.getElementById('toggle-fullscreen');
            const clearConsoleBtn = document.getElementById('clear-console');
            const devConsole = document.getElementById('dev-console');
            const devConsoleContent = document.getElementById('dev-console-content');
            const iframeContainer = document.getElementById('iframe-container');
            const scormContent = document.getElementById('scorm-content');
            const debugToggle = document.getElementById('debug-toggle');
            const debugPanel = document.getElementById('debug-panel');
            const debugContent = document.getElementById('debug-content');
            
            // Override console.log to capture in our dev console
            const originalConsoleLog = console.log;
            console.log = function() {
                // Call original console.log
                originalConsoleLog.apply(console, arguments);
                
                // Add to our dev console
                const logEntry = document.createElement('div');
                logEntry.className = 'log-entry';
                logEntry.textContent = Array.from(arguments).join(' ');
                devConsoleContent.appendChild(logEntry);
                devConsoleContent.scrollTop = devConsoleContent.scrollHeight;
            };
            
            // Console toggle
            toggleConsoleBtn.addEventListener('click', function() {
                devConsole.classList.toggle('visible');
                iframeContainer.classList.toggle('with-console');
                toggleConsoleBtn.textContent = devConsole.classList.contains('visible') ? 'Hide Console' : 'Show Console';
            });
            
            // Clear console
            clearConsoleBtn.addEventListener('click', function() {
                devConsoleContent.innerHTML = '';
            });
            
            // Fullscreen toggle
            toggleFullscreenBtn.addEventListener('click', function() {
                if (document.fullscreenElement) {
                    document.exitFullscreen();
                } else {
                    scormContent.requestFullscreen();
                }
            });

            // Restart course functionality
            const restartBtn = document.getElementById('restart-course');
            if (restartBtn) {
                restartBtn.addEventListener('click', function() {
                    if (confirm('Are you sure you want to restart this course? All progress will be lost.')) {
                        // Redirect to launch without the current attempt ID to force a new attempt
                        window.location.href = '/Scorm/Launch?courseId=@Model.CourseId&userId=@Model.UserId&forceNew=true';
                    }
                });
            }
            
            // Log successful initialization
            console.log('Development tools initialized');
            console.log('SCORM content URL: ' + '@cleanUrl');
            console.log('LaunchUrl passed to iframe:', '@cleanUrl');

            // Validate URL parameters
            const iframeUrl = '@cleanUrl';
            const hasAttemptId = iframeUrl.includes('attemptId=');
            const hasCourseId = iframeUrl.includes('courseId=');
            const hasUserId = iframeUrl.includes('userId=');

            console.log('URL Parameter Validation:');
            console.log('- Has attemptId:', hasAttemptId);
            console.log('- Has courseId:', hasCourseId);
            console.log('- Has userId:', hasUserId);

            if (!hasAttemptId) {
                console.error('‚ö†Ô∏è CRITICAL: attemptId is missing from iframe URL! This will cause save operations to fail.');
                console.error('Expected attemptId: @(ViewBag.AttemptId)');
                console.error('Current URL: ' + iframeUrl);
            }

            // Log ViewModel data for debugging
            console.log('ViewModel data:');
            console.log('- CourseId: @Model.CourseId');
            console.log('- UserId: @Model.UserId');
            console.log('- AttemptId: @Model.AttemptId');
            console.log('- IsResume: @Model.IsResume');
            console.log('- Original LaunchUrl: @Model.LaunchUrl');

            // Debug panel functionality
            debugToggle.addEventListener('click', function() {
                debugPanel.classList.toggle('show');
                updateDebugPanel();
            });

            // Function to update debug panel with current status
            function updateDebugPanel() {
                const debugInfo = window.scormDebugInfo;
                const currentParams = window.getQueryParams ? window.getQueryParams() : {};

                let html = '';

                // ViewBag data
                html += '<div class="debug-item"><strong>ViewBag Data:</strong></div>';
                html += `<div class="debug-item">AttemptId: <span class="${debugInfo.attemptId ? 'debug-ok' : 'debug-error'}">${debugInfo.attemptId || 'MISSING'}</span></div>`;
                html += `<div class="debug-item">CourseId: <span class="${debugInfo.courseId ? 'debug-ok' : 'debug-error'}">${debugInfo.courseId || 'MISSING'}</span></div>`;
                html += `<div class="debug-item">UserId: <span class="${debugInfo.userId ? 'debug-ok' : 'debug-error'}">${debugInfo.userId || 'MISSING'}</span></div>`;

                // URL validation
                html += '<div class="debug-item" style="margin-top: 8px;"><strong>URL Status:</strong></div>';
                html += `<div class="debug-item">Has AttemptId in URL: <span class="${debugInfo.hasAttemptIdInUrl ? 'debug-ok' : 'debug-error'}">${debugInfo.hasAttemptIdInUrl ? 'YES' : 'NO'}</span></div>`;
                html += `<div class="debug-item">Original LaunchUrl: <span class="${debugInfo.originalLaunchUrl ? 'debug-ok' : 'debug-warning'}">${debugInfo.originalLaunchUrl || 'None'}</span></div>`;

                // Current extracted parameters
                html += '<div class="debug-item" style="margin-top: 8px;"><strong>Extracted Parameters:</strong></div>';
                if (Object.keys(currentParams).length > 0) {
                    for (const [key, value] of Object.entries(currentParams)) {
                        const isRequired = ['attemptId', 'courseId', 'userId'].includes(key);
                        const cssClass = value ? (isRequired ? 'debug-ok' : '') : 'debug-error';
                        html += `<div class="debug-item">${key}: <span class="${cssClass}">${value || 'MISSING'}</span></div>`;
                    }
                } else {
                    html += '<div class="debug-item debug-error">No parameters extracted!</div>';
                }

                // Status summary
                html += '<div class="debug-item" style="margin-top: 8px;"><strong>Status:</strong></div>';
                const hasAttemptId = currentParams.attemptId || debugInfo.attemptId;
                html += `<div class="debug-item">Save Operations: <span class="${hasAttemptId ? 'debug-ok' : 'debug-error'}">${hasAttemptId ? 'SHOULD WORK' : 'WILL FAIL'}</span></div>`;

                debugContent.innerHTML = html;
            }

            // Update debug panel every 5 seconds
            setInterval(updateDebugPanel, 5000);

            // Expose progress update function globally for testing
            window.updateMainProgressDisplay = updateMainProgressDisplay;

            // Log resume data for debugging
            console.log('ResumeData:', window.scormResumeData);

            // Add page unload handler to save state before leaving
            window.addEventListener('beforeunload', function(event) {
                if (window.API && typeof window.API.LMSCommit === 'function') {
                    try {
                        window.API.LMSCommit('');
                        console.log('Emergency save on page unload (SCORM 1.2)');
                    } catch (e) {
                        console.error('Failed to save on unload:', e);
                    }
                }
                if (window.API_1484_11 && typeof window.API_1484_11.Commit === 'function') {
                    try {
                        window.API_1484_11.Commit('');
                        console.log('Emergency save on page unload (SCORM 2004)');
                    } catch (e) {
                        console.error('Failed to save on unload:', e);
                    }
                }
            });

            // Add periodic heartbeat to detect if iframe is responsive
            let heartbeatInterval;
            function startHeartbeat() {
                heartbeatInterval = setInterval(() => {
                    try {
                        const iframe = document.getElementById('scorm-content');
                        if (iframe && iframe.contentWindow) {
                            // Check if SCORM content is still responsive
                            console.log('Heartbeat: SCORM content responsive');
                        }
                    } catch (e) {
                        console.warn('Heartbeat: SCORM content may not be responsive');
                    }
                }, 60000); // Check every minute
            }

            startHeartbeat();

            // Message listener for progress updates from iframe
            window.addEventListener('message', function(event) {
                if (event.data && event.data.type === 'scormProgressUpdate') {
                    const progressPercent = event.data.progressPercent || 0;
                    updateMainProgressDisplay(progressPercent);
                }
            });

            // Function to update the main progress display
            function updateMainProgressDisplay(progressPercent) {
                const progressBar = document.getElementById('main-progress-bar');
                const progressText = document.getElementById('main-progress-text');

                if (progressBar) {
                    progressBar.style.width = progressPercent + '%';
                }
                if (progressText) {
                    progressText.textContent = Math.round(progressPercent) + '% complete';
                }

                console.log('üéØ Main progress updated:', progressPercent + '%');
            }

            // Cleanup on page unload
            window.addEventListener('unload', () => {
                if (heartbeatInterval) {
                    clearInterval(heartbeatInterval);
                }
            });
        });
    </script>
</body>
</html>
